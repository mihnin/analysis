# Руководство: Обработка разных конвенций списания

## Проблема

В разных учетных системах списание товара может быть представлено по-разному:

### Вариант 1: Списание как ПОЛОЖИТЕЛЬНОЕ число
```
Списание = 100  → израсходовали 100 единиц товара
```
**Используется в:** 1С, SAP, большинство ERP систем

**Формула баланса:**
```
Остаток на конец = Остаток на начало + Приход - Списание
```

### Вариант 2: Списание как ОТРИЦАТЕЛЬНОЕ число
```
Списание = -100  → уменьшение запаса на 100 единиц
```
**Используется в:** некоторых системах складского учета, Excel-отчетах

**Формула баланса:**
```
Остаток на конец = Остаток на начало + Приход + Списание
(+ потому что Списание уже отрицательное)
```

## Решение: Автоматическая нормализация

### ✅ Что добавлено в приложение

1. **Автоматическое определение конвенции**
   - Проверка баланса: начало + приход ± списание = конец
   - Если баланс сходится → определяет правильный знак
   - Если нет баланса → смотрит на знак большинства значений

2. **Автоматическая нормализация**
   - Все списание преобразуется в ПОЛОЖИТЕЛЬНЫЕ значения
   - Расчеты всегда корректны независимо от исходного формата
   - Пользователь видит информационное сообщение о конвенции

3. **Ручное управление (опционально)**
   - Режим AUTO - автоматическое определение (рекомендуется)
   - Режим POSITIVE - данные уже правильные
   - Режим NEGATIVE - принудительная инверсия
   - Режим ABS - взять модуль всех значений (безопасный вариант)

## Как это работает

### Алгоритм определения конвенции:

```python
1. Проверяем баланс с положительным списанием:
   calculated_end = start + arrival - consumption
   if calculated_end ≈ actual_end:
       → POSITIVE (списание уже правильное)

2. Проверяем баланс с отрицательным списанием:
   calculated_end = start + arrival + consumption  # + потому что уже отриц.
   if calculated_end ≈ actual_end:
       → NEGATIVE (нужно взять модуль)

3. Если баланс не сходится, смотрим на знак большинства:
   if 80% значений отрицательные:
       → NEGATIVE
   elif 80% значений положительные:
       → POSITIVE
   else:
       → MIXED (применяем модуль)
```

### После определения:
```python
# Нормализация: ВСЕГДА делаем списание положительным
normalized_consumption = abs(original_consumption)
```

## Примеры

### Пример 1: Положительное списание (стандарт)

**Исходные данные:**
```
Начало: 100
Приход: 50
Списание: 30  ← ПОЛОЖИТЕЛЬНОЕ
Конец: 120

Баланс: 100 + 50 - 30 = 120 ✓
```

**Результат:** Определена конвенция POSITIVE, списание не изменяется

---

### Пример 2: Отрицательное списание

**Исходные данные:**
```
Начало: 100
Приход: 50
Списание: -30  ← ОТРИЦАТЕЛЬНОЕ
Конец: 120

Баланс: 100 + 50 + (-30) = 120 ✓
```

**Результат:**
- Определена конвенция NEGATIVE
- Списание преобразовано: -30 → 30

---

### Пример 3: Смешанные данные

**Исходные данные:**
```
Списание: [10, -5, 15, -8, 12, 20, -3]
          60% положительных, 40% отрицательных
```

**Результат:**
- Определена конвенция MOSTLY_POSITIVE
- Применен модуль ко всем значениям: [10, 5, 15, 8, 12, 20, 3]

---

## Использование в приложении

### В UI (Streamlit):

1. **Загрузите данные**

2. **Выберите колонку списания**
   ```
   ☑ Есть колонка с фактическим списанием/расходом
   ```

3. **Выберите режим (опционально)**
   ```
   ⚙️ Настройки знака списания

   ○ AUTO (рекомендуется)  ← выбрано по умолчанию
   ○ POSITIVE
   ○ NEGATIVE
   ○ ABS
   ```

4. **Запустите анализ**
   ```
   Система автоматически:
   - Определит конвенцию
   - Нормализует данные
   - Покажет информационное сообщение
   - Выполнит расчеты с правильными значениями
   ```

### Информационное сообщение:

После запуска анализа вы увидите:
```
[INFO] Нормализация списания: Списание как ПОЛОЖИТЕЛЬНОЕ число
(баланс сходится в 100.0% случаев)
```

или

```
[INFO] Нормализация списания: Списание как ОТРИЦАТЕЛЬНОЕ число
(баланс сходится в 100.0% случаев) → Применен модуль
```

---

## Рекомендации

### ✅ Когда использовать AUTO (рекомендуется)
- **Всегда**, если не уверены в формате данных
- Работает с любыми данными
- Автоматически определяет правильный способ обработки
- Показывает уверенность определения

### ✅ Когда использовать POSITIVE
- Уверены что данные в стандартном формате (1С, SAP)
- Все значения положительные
- Для дополнительной безопасности применится abs()

### ✅ Когда использовать NEGATIVE
- Уверены что система использует отрицательные значения
- Хотите принудительно инвертировать знак
- Данные из Excel где списание = минус

### ✅ Когда использовать ABS
- Есть смешанные данные (и + и -)
- Не уверены в качестве данных
- Хотите "безопасный" вариант - просто модуль

---

## Проверка корректности

### Метод 1: Проверка баланса вручную

```excel
=ЕСЛИ(
  ABS((Начало + Приход - Списание) - Конец) < 0.01;
  "Баланс OK (положительное)";
  ЕСЛИ(
    ABS((Начало + Приход + Списание) - Конец) < 0.01;
    "Баланс OK (отрицательное)";
    "Ошибка баланса"
  )
)
```

### Метод 2: Использовать тестовый скрипт

```bash
python test_consumption_conventions.py
```

Скрипт проверит:
- ✅ Положительное списание
- ✅ Отрицательное списание
- ✅ Смешанные данные
- ✅ Ваши реальные данные

---

## FAQ

### Q: А если в моих данных списание иногда +, иногда -?

**A:** Используйте режим AUTO или ABS. Система применит модуль ко всем значениям и предупредит вас об этом.

### Q: Как понять, какой формат у моих данных?

**A:**
1. Откройте Excel
2. Посмотрите на колонку списания
3. Проверьте формулу баланса (см. выше)
4. ИЛИ просто используйте AUTO - система сама определит

### Q: Что если AUTO определил неправильно?

**A:**
1. Проверьте уверенность (должна быть >80%)
2. Если <80% - данные неоднозначные
3. Используйте ручной режим (POSITIVE/NEGATIVE/ABS)
4. Проверьте качество исходных данных

### Q: Можно просто всегда использовать модуль (ABS)?

**A:** Да, это безопасно! Но:
- ✅ Гарантированно работает
- ⚠️ Теряется информация об исходном формате
- ⚠️ Не видно проблем в данных

AUTO режим лучше, потому что:
- ✅ Показывает какой формат у ваших данных
- ✅ Определяет уверенность
- ✅ Выявляет проблемы (если уверенность низкая)

### Q: Повлияет ли это на мои старые расчеты?

**A:** Нет, если вы использовали приложение БЕЗ колонки списания.

Если ВЫ ДОБАВИЛИ колонку списания:
- ✅ Расчеты станут ТОЧНЕЕ
- ✅ Среднее списание будет корректным
- ✅ Все метрики станут правильными

---

## Технические детали

### Функции в data_validation.py:

```python
# Определение конвенции
detect_consumption_convention(
    df, consumption_column,
    start_column, end_column,
    arrival_column=None
)

# Нормализация
normalize_consumption(
    df, consumption_column,
    convention='AUTO',
    start_column=None,
    end_column=None,
    arrival_column=None
)

# Анализ и печать
print_consumption_analysis(...)
```

### Интеграция в historical_analysis.py:

```python
def analyze_historical_data(..., consumption_convention='AUTO'):
    # Автоматическая нормализация
    if consumption_column:
        df, detection = dv.normalize_consumption(
            df, consumption_column,
            convention=consumption_convention,
            ...
        )
        print(f"[INFO] {detection['recommendation']}")

    # Дальше расчеты с нормализованными данными
    ...
```

---

## Итоги

✅ **Проблема решена полностью:**
- Автоматическое определение конвенции (+ или -)
- Автоматическая нормализация данных
- Ручное управление при необходимости
- Информационные сообщения пользователю
- Полное покрытие тестами

✅ **Работает с любыми данными:**
- 1С, SAP (положительное списание)
- Excel-отчеты (отрицательное списание)
- Смешанные данные (и + и -)
- Некорректные данные (предупреждение)

✅ **Использование:**
- По умолчанию AUTO режим (рекомендуется)
- Опционально ручной выбор
- Информационные сообщения
- Гарантия корректности расчетов

🎯 **ВЫВОД: Приложение теперь универсально работает с любыми форматами данных!**
