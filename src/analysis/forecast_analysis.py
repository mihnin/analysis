import pandas as pd
import numpy as np
from statsmodels.tsa.holtwinters import ExponentialSmoothing
import plotly.express as px
import sys
from pathlib import Path

# ะะพะฑะฐะฒะปัะตะผ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั ะฒ PYTHONPATH
root_dir = Path(__file__).parent.parent.parent
sys.path.insert(0, str(root_dir))

from src.analysis import forecasting_models as fm

def analyze_forecast_data(df, date_column, material_column, branch_column, demand_column,
                          start_balance_column, end_balance_column, recommendation_column,
                          future_demand_column, safety_stock_column):
    analysis_df = df.copy()
    numeric_columns = [demand_column, start_balance_column, end_balance_column,
                       recommendation_column, future_demand_column, safety_stock_column]
    analysis_df[numeric_columns] = analysis_df[numeric_columns].round(1)
    analysis_df = analysis_df.sort_values([date_column, material_column, branch_column])

    # ะะกะะะะะะะะะ ะะจะะะะ #3: ะฃะะะะะะ ะฟัะธะผะตะฝะตะฝะธะต Exponential Smoothing
    # ะัะธัะธะฝะฐ: ะะตัะตะทะฐะฟะธัั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะน ะฟะพััะตะฑะฝะพััะธ ะฝะตะบะพััะตะบัะฝะฐ ะธ ะฟัะพะธััะพะดะธั
    # ะะะกะะ ะฒัะตั ัะฐััะตัะพะฒ, ััะพ ะดะตะปะฐะตั ะฟัะตะดัะดััะธะต ัะฐััะตัั ะฑะตััะผััะปะตะฝะฝัะผะธ.
    # ะัะปะธ ะฝัะถะฝะพ ัะณะปะฐะถะธะฒะฐะฝะธะต ะดะปั ะฒะธะทัะฐะปะธะทะฐัะธะธ, ัะพะทะดะฐะนัะต ะพัะดะตะปัะฝัั ะบะพะปะพะฝะบั.

    explanation = get_explanation(analysis_df.iloc[0], date_column, material_column, branch_column,
                                  demand_column, start_balance_column, end_balance_column,
                                  recommendation_column, future_demand_column, safety_stock_column)

    return analysis_df, explanation

def get_explanation(row, date_column, material_column, branch_column, demand_column,
                    start_balance_column, end_balance_column, recommendation_column,
                    future_demand_column, safety_stock_column, forecast_mode='manual',
                    forecast_model=None, forecast_periods=None):
    """
    ะะตะฝะตัะธััะตั ะฟะพะดัะพะฑะฝะพะต ะพะฑัััะฝะตะฝะธะต ัะฐััะตัะพะฒ ะฟัะพะณะฝะพะทะฐ

    Parameters:
    -----------
    forecast_mode : str
        ะะตะถะธะผ ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั: 'auto' (ะฐะฒัะพะผะฐัะธัะตัะบะธะน) ะธะปะธ 'manual' (ะธะท ัะฐะนะปะฐ)
    forecast_model : str, optional
        ะะพะดะตะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั (ะดะปั auto ัะตะถะธะผะฐ): 'naive', 'moving_average', 'exponential_smoothing', 'holt_winters', 'sarima', 'auto'
    forecast_periods : int, optional
        ะะพะปะธัะตััะฒะพ ะฟะตัะธะพะดะพะฒ ะฟัะพะณะฝะพะทะฐ (ะดะปั auto ัะตะถะธะผะฐ)
    """

    # ะคะพัะผะธััะตะผ ะทะฐะณะพะปะพะฒะพะบ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะตะถะธะผะฐ
    if forecast_mode == 'auto':
        mode_header = f"""
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ค ะะะะะ ะะะะะะะะะะะะะะะฏ: ะะะขะะะะขะะงะะกะะะ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    ๐ **ะััะพัะฝะธะบ ะดะฐะฝะฝัั ะพ ัะฟัะพัะต:**
    โ ะัะพะณะฝะพะท ัะฟัะพัะฐ ะฑัะป ะะะขะะะะขะะงะะกะะ ะกะะะะะะะะะะะ ัะธััะตะผะพะน ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั ะฟะพััะตะฑะปะตะฝะธั
    โ ะะพะดะตะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั: **{forecast_model.upper() if forecast_model else 'AUTO'}**
    โ ะะพะปะธัะตััะฒะพ ะฟะตัะธะพะดะพะฒ ะฟัะพะณะฝะพะทะฐ: **{forecast_periods} ะผะตัััะตะฒ**
    โ ะคะฐะนะป ั ะฟะปะฐะฝะพะฒัะผ ัะฟัะพัะพะผ: **ะะ ะะะะะะกะขะะะะะ** (ัะธััะตะผะฐ ัะฐะผะฐ ะฟะพัััะพะธะปะฐ ะฟัะพะณะฝะพะท)

    ๐ **ะะฐะบ ัะฐะฑะพัะฐะตั ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฟัะพะณะฝะพะท:**
    1. ะกะธััะตะผะฐ ะฐะฝะฐะปะธะทะธััะตั ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต ะพ ะฟะพััะตะฑะปะตะฝะธะธ ะผะฐัะตัะธะฐะปะพะฒ
    2. ะััะฒะปัะตั ััะตะฝะดั, ัะตะทะพะฝะฝะพััั ะธ ะฟะฐััะตัะฝั ะฟะพััะตะฑะปะตะฝะธั
    3. ะัะธะผะตะฝัะตั ะฟัะพัะตััะธะพะฝะฐะปัะฝัั ะผะพะดะตะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั ะฒัะตะผะตะฝะฝัั ััะดะพะฒ
    4. ะะตะฝะตัะธััะตั ะฟัะพะณะฝะพะท ัะฟัะพัะฐ ะฝะฐ ัะปะตะดัััะธะต {forecast_periods} ะฟะตัะธะพะดะพะฒ
    5. ะัะฟะพะปัะทัะตั ััะพั ะฟัะพะณะฝะพะท ะดะปั ัะฐััะตัะฐ ัะตะบะพะผะตะฝะดะฐัะธะน ะฟะพ ะทะฐะบัะฟะบะฐะผ

    ๐ก **ะัะตะธะผััะตััะฒะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะฟัะพะณะฝะพะทะฐ:**
    - ะะต ััะตะฑัะตั ัััะฝะพะน ะฟะพะดะณะพัะพะฒะบะธ ัะฐะนะปะฐ ั ะฟะปะฐะฝะพะฒัะผ ัะฟัะพัะพะผ
    - ะฃัะธััะฒะฐะตั ะธััะพัะธัะตัะบะธะต ะฟะฐััะตัะฝั ะฟะพััะตะฑะปะตะฝะธั
    - ะะดะฐะฟัะธััะตััั ะบ ััะตะฝะดะฐะผ ะธ ัะตะทะพะฝะฝะพััะธ
    - ะญะบะพะฝะพะผะธั ะฒัะตะผั ะฝะฐ ะฟะปะฐะฝะธัะพะฒะฐะฝะธะต

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    """
    else:
        mode_header = f"""
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะะะะ ะะะะะะะะะะะะะะะฏ: ะะฃะงะะะ (ะะ ะคะะะะ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    ๐ **ะััะพัะฝะธะบ ะดะฐะฝะฝัั ะพ ัะฟัะพัะต:**
    โ ะะปะฐะฝะพะฒัะน ัะฟัะพั ะฑัะป ะะะะะะกะขะะะะะ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ ะฒ ัะฐะนะปะต Excel
    โ ะกะธััะตะผะฐ ะธัะฟะพะปัะทัะตั ะฒะฐัะธ ะดะฐะฝะฝัะต ะธะท ะบะพะปะพะฝะบะธ ั ะฟะปะฐะฝะพะฒัะผ ัะฟัะพัะพะผ
    โ ะัะพะณะฝะพะท ะพัะฝะพะฒะฐะฝ ะฝะฐ ะฒะฐัะธั ะฑะธะทะฝะตั-ะฟะปะฐะฝะฐั ะธ ะฟัะพะณะฝะพะทะฐั

    ๐ **ะะฐะบ ัะฐะฑะพัะฐะตั ัััะฝะพะน ัะตะถะธะผ:**
    1. ะั ะฟัะตะดะพััะฐะฒะธะปะธ ัะฐะนะป Excel ั ะบะพะปะพะฝะบะพะน "ะะปะฐะฝะพะฒัะน ัะฟัะพั" (ะธะปะธ ะฐะฝะฐะปะพะณะธัะฝะพะน)
    2. ะกะธััะตะผะฐ ััะธััะฒะฐะตั ะฒะฐัะธ ะฟะปะฐะฝะพะฒัะต ะทะฝะฐัะตะฝะธั ัะฟัะพัะฐ ะฝะฐ ะบะฐะถะดัะน ะฟะตัะธะพะด
    3. ะัะฟะพะปัะทัะตั ััะธ ะทะฝะฐัะตะฝะธั ะดะปั ัะฐััะตัะฐ ะฟัะพะณะฝะพะทะฐ ะพััะฐัะบะพะฒ ะธ ัะตะบะพะผะตะฝะดะฐัะธะน ะฟะพ ะทะฐะบัะฟะบะฐะผ
    4. ะัะต ะพััะฐะปัะฝัะต ะฟะพะบะฐะทะฐัะตะปะธ (ัััะฐัะพะฒะพะน ะทะฐะฟะฐั, ะฑัะดััะธะน ัะฟัะพั, ัะตะบะพะผะตะฝะดะฐัะธะธ) ัะฐัััะธััะฒะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ

    ๐ก **ะัะตะธะผััะตััะฒะฐ ัััะฝะพะณะพ ัะตะถะธะผะฐ:**
    - ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ะฟะปะฐะฝะพะฒัะผ ัะฟัะพัะพะผ
    - ะะพะถะฝะพ ััะตััั ะฑะธะทะฝะตั-ะฟะปะฐะฝั, ะผะฐัะบะตัะธะฝะณะพะฒัะต ะบะฐะผะฟะฐะฝะธะธ, ัะตะทะพะฝะฝัะต ะฐะบัะธะธ
    - ะะพะทะผะพะถะฝะพััั ะบะพััะตะบัะธัะพะฒะบะธ ะฟัะพะณะฝะพะทะฐ ะฝะฐ ะพัะฝะพะฒะต ัะบัะฟะตััะฝะพะน ะพัะตะฝะบะธ
    - ะะพะดัะพะดะธั ะดะปั ัะปััะฐะตะฒ, ะบะพะณะดะฐ ั ะฒะฐั ะตััั ัะพัะฝัะต ะฟะปะฐะฝั ะฟัะพะดะฐะถ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    """

    explanation = mode_header + f"""

    ะะพััะฝะตะฝะธะต ัะฐััะตัะพะฒ ะฝะฐ ะฟัะธะผะตัะต:

    ะะฐััะผะพััะธะผ ัััะพะบั ะดะปั {row[material_column]} ะฒ {row[branch_column]} ะฝะฐ ะดะฐัั {row[date_column]}:

    1. **ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะฐั ะฟะพััะตะฑะฝะพััั**: {row[demand_column]}
       - {'ะญัะพ ะทะฝะฐัะตะฝะธะต ะฑัะปะพ ะะะขะะะะขะะงะะกะะ ะกะะะะะะะะะะะะะะ ัะธััะตะผะพะน ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั ะฟะพััะตะฑะปะตะฝะธั.' if forecast_mode == 'auto' else 'ะญัะพ ะทะฝะฐัะตะฝะธะต ะฑะตัะตััั ะฝะฐะฟััะผัั ะธะท ะทะฐะณััะถะตะฝะฝะพะณะพ ะฒะฐะผะธ ัะฐะนะปะฐ Excel ั ะฟะปะฐะฝะพะฒัะผ ัะฟัะพัะพะผ.'}
       - ะงัะพ ะดะตะปะฐัั: ะัะฟะพะปัะทัะนัะต ััะพ ะทะฝะฐัะตะฝะธะต ะดะปั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ะทะฐะบัะฟะพะบ ะฝะฐ ัะบะฐะทะฐะฝะฝัั ะดะฐัั, ััะพะฑั ะธะทะฑะตะถะฐัั ะฝะตัะฒะฐัะบะธ ะผะฐัะตัะธะฐะปะฐ.

    2. **ะัะพะณะฝะพะท ะพััะฐัะบะฐ ะฝะฐ ะฝะฐัะฐะปะพ**: {row[start_balance_column]}
       - ะะฐัััะธััะฒะฐะตััั ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั, ะฟัะตะดัะดััะตะณะพ ะฟัะพะณะฝะพะทะฐ ะธะปะธ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะผะพะดะตะปะธ Exponential Smoothing.
       - ะะพะดะตะปั Exponential Smoothing ะฟะพะผะพะณะฐะตั ะฟัะตะดัะบะฐะทะฐัั, ัะบะพะปัะบะพ ะผะฐัะตัะธะฐะปะฐ ะพััะฐะฝะตััั, ััะธััะฒะฐั ะฟัะพัะปะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะธ ััะตะฝะดั.
       - ะัะตะดััะฐะฒะปัะตั ะพะถะธะดะฐะตะผัะน ะพััะฐัะพะบ {row[material_column]} ะฒ {row[branch_column]} ะฝะฐ ะฝะฐัะฐะปะพ ะดะฝั {row[date_column]}.
       - ะงัะพ ะดะตะปะฐัั: ะกัะฐะฒะฝะธัะต ััะพั ะพััะฐัะพะบ ั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะน ะฟะพััะตะฑะฝะพัััั, ััะพะฑั ะฟะพะฝััั, ะดะพััะฐัะพัะฝะพ ะปะธ ะผะฐัะตัะธะฐะปะฐ.

    3. **ะัะพะณะฝะพะท ะพััะฐัะบะฐ ะฝะฐ ะบะพะฝะตั**: {row[end_balance_column]}
       - ะััะธัะปัะตััั ะบะฐะบ: ะัะพะณะฝะพะท ะพััะฐัะบะฐ ะฝะฐ ะฝะฐัะฐะปะพ - ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะฐั ะฟะพััะตะฑะฝะพััั
       - {row[start_balance_column]} - {row[demand_column]} = {row[end_balance_column]}
       - ะญัะพ ะพะถะธะดะฐะตะผัะน ะพััะฐัะพะบ {row[material_column]} ะฒ {row[branch_column]} ะฒ ะบะพะฝัะต ะดะฝั {row[date_column]} ะฟะพัะปะต ัะดะพะฒะปะตัะฒะพัะตะฝะธั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะน ะฟะพััะตะฑะฝะพััะธ.
       - ะงัะพ ะดะตะปะฐัั: ะัะปะธ ะฟัะพะณะฝะพะท ะพััะฐัะบะฐ ะฝะฐ ะบะพะฝะตั ัะปะธัะบะพะผ ะผะฐะป, ะฟะพะดัะผะฐะนัะต ะพ ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะทะฐะบัะฟะบะฐั, ััะพะฑั ะธะทะฑะตะถะฐัั ะฝะตัะฒะฐัะบะธ.

    4. **ะะตะบะพะผะตะฝะดะฐัะธั ะฟะพ ะทะฐะบัะฟะบะต**: {row[recommendation_column]}
       - ะะฐัััะธััะฒะฐะตััั ะฝะฐ ะพัะฝะพะฒะต ะฑัะดััะตะณะพ ัะฟัะพัะฐ ะธ ัะตะบััะธั ะพััะฐัะบะพะฒ ั ััะตัะพะผ ัััะฐัะพะฒะพะณะพ ะทะฐะฟะฐัะฐ.
       - ะคะพัะผัะปะฐ: max(0, ะัะดััะธะน ัะฟัะพั + ะกััะฐัะพะฒะพะน ะทะฐะฟะฐั - ะัะพะณะฝะพะท ะพััะฐัะบะฐ ะฝะฐ ะบะพะฝะตั)
       - max(0, {row[future_demand_column]} + {row[safety_stock_column]} - {row[end_balance_column]}) = {row[recommendation_column]}
       - ะงัะพ ะดะตะปะฐัั: ะัะปะธ ะทะฝะฐัะตะฝะธะต ะฑะพะปััะต 0, ะฝะตะพะฑัะพะดะธะผะพ ะทะฐะบะฐะทะฐัั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ะผะฐัะตัะธะฐะปะฐ, ััะพะฑั ะฟะพะบัััั ะฑัะดััะธะน ัะฟัะพั ะธ ะธะทะฑะตะถะฐัั ะฝะตัะฒะฐัะบะธ.

    5. **ะัะดััะธะน ัะฟัะพั**: {row[future_demand_column]}
       - ะกัะผะผะฐ ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝัั ะฟะพััะตะฑะฝะพััะตะน ะทะฐ ัะตะบััะธะน ะธ ะดะฒะฐ ัะปะตะดัััะธั ะฟะตัะธะพะดะฐ.
       - ะัะตะดััะฐะฒััะต, ััะพ ะฒั ัะฟัะฐะฒะปัะตัะต ัะบะปะฐะดะพะผ ัััะพะธัะตะปัะฝัั ะผะฐัะตัะธะฐะปะพะฒ. ะัะดััะธะน ัะฟัะพั โ ััะพ ัะพ, ัะบะพะปัะบะพ ะผะฐัะตัะธะฐะปะฐ ะฒะฐะผ ะฟะพะฝะฐะดะพะฑะธััั ะฒ ะฑะปะธะถะฐะนัะตะต ะฒัะตะผั.
       
       ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั:
       - ะัะปะธ ัะตะณะพะดะฝั ะฟะพะฝะตะดะตะปัะฝะธะบ, ะฒั ัะผะพััะธัะต ะฝะฐ ะฟะพััะตะฑะฝะพััั ะฒ ะผะฐัะตัะธะฐะปะต ะฝะฐ ะฟะพะฝะตะดะตะปัะฝะธะบ, ะฒัะพัะฝะธะบ ะธ ััะตะดั.
       - ะะฐะฟัะธะผะตั, ะตัะปะธ ะฒ ะฟะพะฝะตะดะตะปัะฝะธะบ ะฝัะถะฝะพ 20 ะตะดะธะฝะธั ะผะฐัะตัะธะฐะปะฐ, ะฒะพ ะฒัะพัะฝะธะบ โ 20, ะฐ ะฒ ััะตะดั โ 14, ัะพ ะฑัะดััะธะน ัะฟัะพั ัะพััะฐะฒะธั: 20 + 20 + 14 = 54 ะตะดะธะฝะธัั.
       
       ะะฐัะตะผ ััะพ ะฝัะถะฝะพ:
       - ะะฝะฐะฝะธะต ะฑัะดััะตะณะพ ัะฟัะพัะฐ ะฟะพะผะพะณะฐะตั ะทะฐัะฐะฝะตะต ะฟะพะดะณะพัะพะฒะธัััั ะธ ัะฑะตะดะธัััั, ััะพ ั ะฒะฐั ะฑัะดะตั ะดะพััะฐัะพัะฝะพ ะผะฐัะตัะธะฐะปะฐ.
       - ะญัะพ ะฟะพะทะฒะพะปัะตั ะธะทะฑะตะถะฐัั ัะธััะฐัะธะน, ะบะพะณะดะฐ ะผะฐัะตัะธะฐะป ะฝะตะพะถะธะดะฐะฝะฝะพ ะทะฐะบะฐะฝัะธะฒะฐะตััั.
       - ะะพะผะพะณะฐะตั ะฟะปะฐะฝะธัะพะฒะฐัั ะทะฐะบัะฟะบะธ ะธ ะฟะพะดะดะตัะถะธะฒะฐัั ะพะฟัะธะผะฐะปัะฝัะน ััะพะฒะตะฝั ะทะฐะฟะฐัะพะฒ.
       
       ะงัะพ ะดะตะปะฐัั:
       - ะัะฟะพะปัะทัะนัะต ััะพั ะฟะพะบะฐะทะฐัะตะปั ะดะปั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ะทะฐะบัะฟะพะบ ะฝะฐ ะฑะปะธะถะฐะนัะตะต ะฒัะตะผั.
       - ะฃะฑะตะดะธัะตัั, ััะพ ั ะฒะฐั ะตััั ะดะพััะฐัะพัะฝะพ ะผะฐัะตัะธะฐะปะฐ ะดะปั ะฟะพะบัััะธั ะฑัะดััะตะณะพ ัะฟัะพัะฐ.
       - ะัะปะธ ัะตะบััะธั ะทะฐะฟะฐัะพะฒ ะฝะตะดะพััะฐัะพัะฝะพ, ัะฐััะผะพััะธัะต ะฒะพะทะผะพะถะฝะพััั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะทะฐะบัะฟะบะธ.
       - ะะตะณัะปััะฝะพ ััะฐะฒะฝะธะฒะฐะนัะต ัะฐะบัะธัะตัะบะธะน ัะฟัะพั ั ะฟัะพะณะฝะพะทะธััะตะผัะผ, ััะพะฑั ัะปัััะฐัั ัะพัะฝะพััั ะฟัะพะณะฝะพะทะพะฒ.

    6. **ะกััะฐัะพะฒะพะน ะทะฐะฟะฐั**: {row[safety_stock_column]}
       - ะะฐัััะธััะฒะฐะตััั ะบะฐะบ ะฟัะพัะตะฝั ะพั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะน ะฟะพััะตะฑะฝะพััะธ.
       - ะะพะผะพะณะฐะตั ะพะฑะตัะฟะตัะธัั ะฝะฐะปะธัะธะต ะดะพััะฐัะพัะฝะพะณะพ ะบะพะปะธัะตััะฒะฐ ะผะฐัะตัะธะฐะปะฐ ะฒ ัะปััะฐะต ะฝะตะฟัะตะดะฒะธะดะตะฝะฝัั ะพะฑััะพััะตะปัััะฒ.
       - ะงัะพ ะดะตะปะฐัั: ะะตัะถะธัะต ะดะพััะฐัะพัะฝัะน ัััะฐัะพะฒะพะน ะทะฐะฟะฐั, ััะพะฑั ะธะทะฑะตะถะฐัั ะฟะตัะตะฑะพะตะฒ ะฒ ะฟะพััะฐะฒะบะฐั ะฟัะธ ะฒะฝะตะทะฐะฟะฝะพะผ ัะฒะตะปะธัะตะฝะธะธ ัะฟัะพัะฐ.

    ะญัะธ ัะฐััะตัั ะฟะพะผะพะณะฐัั ะพะฟัะธะผะธะทะธัะพะฒะฐัั ัะฟัะฐะฒะปะตะฝะธะต ะทะฐะฟะฐัะฐะผะธ, ะพะฑะตัะฟะตัะธะฒะฐั ะดะพััะฐัะพัะฝะพะต ะบะพะปะธัะตััะฒะพ ะผะฐัะตัะธะฐะปะพะฒ
    ะดะปั ัะดะพะฒะปะตัะฒะพัะตะฝะธั ัะฟัะพัะฐ ะธ ะฟะพะดะดะตัะถะฐะฝะธั ัััะฐัะพะฒะพะณะพ ะทะฐะฟะฐัะฐ, ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะผะธะฝะธะผะธะทะธััั ะธะทะปะธัะบะธ. ะญัะพ ะทะฝะฐัะธั, ััะพ ะฒั ะผะพะถะตัะต ัะพะบัะฐัะธัั ะธะทะปะธัะฝะธะต ัะฐััะพะดั ะธ ะฝะต ะดะพะฟัััะธัั ะฝะตัะฒะฐัะบะธ.
    """

    # ะะพะฑะฐะฒะปัะตะผ ะพะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั ัะพะปัะบะพ ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะตะถะธะผะฐ
    if forecast_mode == 'auto' and forecast_model:
        model_descriptions = {
            'naive': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: NAIVE (ะะะะะะะฏ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ:**
    Naive forecasting - ััะพ ะฟัะพััะตะนัะฐั ะผะพะดะตะปั, ะบะพัะพัะฐั ะฟัะตะดะฟะพะปะฐะณะฐะตั, ััะพ ะฑัะดััะธะน ัะฟัะพั ะฑัะดะตั ัะฐะฒะตะฝ ะฟะพัะปะตะดะฝะตะผั ะธะทะฒะตััะฝะพะผั ะทะฝะฐัะตะฝะธั.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    - ะะตัะตััั ะฟะพัะปะตะดะฝะตะต ะทะฝะฐัะตะฝะธะต ะฟะพััะตะฑะปะตะฝะธั ะธะท ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั
    - ะญัะพ ะทะฝะฐัะตะฝะธะต ะธัะฟะพะปัะทัะตััั ะบะฐะบ ะฟัะพะณะฝะพะท ะดะปั ะฒัะตั ะฑัะดััะธั ะฟะตัะธะพะดะพะฒ
    - ะคะพัะผัะปะฐ: ะัะพะณะฝะพะท(t+1) = ะคะฐะบั(t)

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะกัะฐะฑะธะปัะฝัะน ัะฟัะพั ะฑะตะท ััะตะฝะดะฐ ะธ ัะตะทะพะฝะฝะพััะธ
    - ะะตะดะพััะฐัะพัะฝะพ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั ะดะปั ัะปะพะถะฝัั ะผะพะดะตะปะตะน
    - ะขัะตะฑัะตััั ะฑัััััะน ะฑะฐะทะพะฒัะน ะฟัะพะณะฝะพะท

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะัะพััะพัะฐ ะธ ัะบะพัะพััั ัะฐััะตัะฐ
    โ ะะต ััะตะฑัะตั ะฝะฐัััะพะนะบะธ ะฟะฐัะฐะผะตััะพะฒ
    โ ะฅะพัะพัะพ ัะฐะฑะพัะฐะตั ะดะปั ััะฐะฑะธะปัะฝะพะณะพ ัะฟัะพัะฐ

    **ะะณัะฐะฝะธัะตะฝะธั:**
    โ๏ธ ะะต ััะธััะฒะฐะตั ััะตะฝะดั
    โ๏ธ ะะต ััะธััะฒะฐะตั ัะตะทะพะฝะฝะพััั
    โ๏ธ ะะพะถะตั ะฑััั ะฝะตัะพัะฝะพะน ะฟัะธ ะธะทะผะตะฝัะธะฒะพะผ ัะฟัะพัะต
    """,
            'moving_average': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: MOVING AVERAGE (ะกะะะะฌะะฏะฉะะ ะกะะะะะะ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ:**
    Moving Average ัะณะปะฐะถะธะฒะฐะตั ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต, ัััะตะดะฝัั ะฝะตัะบะพะปัะบะพ ะฟะพัะปะตะดะฝะธั ะทะฝะฐัะตะฝะธะน.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    - ะะตัะตััั ััะตะดะฝะตะต ะทะฝะฐัะตะฝะธะต ะทะฐ ะฟะพัะปะตะดะฝะธะต N ะฟะตัะธะพะดะพะฒ (ะพะฑััะฝะพ N=3)
    - ะญัะพ ััะตะดะฝะตะต ะธัะฟะพะปัะทัะตััั ะบะฐะบ ะฟัะพะณะฝะพะท
    - ะคะพัะผัะปะฐ: ะัะพะณะฝะพะท = (ะคะฐะบั(t) + ะคะฐะบั(t-1) + ะคะฐะบั(t-2)) / 3

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะกะฟัะพั ั ะฝะตะฑะพะปััะธะผะธ ะบะพะปะตะฑะฐะฝะธัะผะธ
    - ะัะถะฝะพ ัะณะปะฐะดะธัั ัะปััะฐะนะฝัะต ะฒัะฑัะพัั
    - ะะตั ัะฒะฝะพะณะพ ััะตะฝะดะฐ ะธะปะธ ัะตะทะพะฝะฝะพััะธ

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะกะณะปะฐะถะธะฒะฐะตั ัะปััะฐะนะฝัะต ะบะพะปะตะฑะฐะฝะธั
    โ ะัะพััะพัะฐ ะฟะพะฝะธะผะฐะฝะธั
    โ ะฃััะพะนัะธะฒะพััั ะบ ะฒัะฑัะพัะฐะผ

    **ะะณัะฐะฝะธัะตะฝะธั:**
    โ๏ธ ะะฐะฟะฐะทะดัะฒะฐะตั ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ััะตะฝะดะฐ
    โ๏ธ ะะต ััะธััะฒะฐะตั ัะตะทะพะฝะฝะพััั
    โ๏ธ ะขัะตะฑัะตั ะฒัะฑะพัะฐ ะพะฟัะธะผะฐะปัะฝะพะณะพ ะพะบะฝะฐ ัััะตะดะฝะตะฝะธั
    """,
            'exponential_smoothing': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: EXPONENTIAL SMOOTHING (ะญะะกะะะะะะฆะะะะฌะะะ ะกะะะะะะะะะะ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ:**
    Exponential Smoothing ะฒะทะฒะตัะธะฒะฐะตั ะฟะพัะปะตะดะฝะธะต ะฝะฐะฑะปัะดะตะฝะธั ัะธะปัะฝะตะต, ัะตะผ ััะฐััะต ะดะฐะฝะฝัะต.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    - ะะพัะปะตะดะฝะธะต ะดะฐะฝะฝัะต ะฟะพะปััะฐัั ะฑะพะปััะธะน ะฒะตั
    - ะกัะฐััะต ะดะฐะฝะฝัะต - ะผะตะฝััะธะน ะฒะตั (ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพ ัะฑัะฒะฐััะธะน)
    - ะคะพัะผัะปะฐ: ะัะพะณะฝะพะท(t+1) = ฮฑระคะฐะบั(t) + (1-ฮฑ)ระัะพะณะฝะพะท(t)
    - ฮฑ (ะฐะปััะฐ) - ะฟะฐัะฐะผะตัั ัะณะปะฐะถะธะฒะฐะฝะธั (0.1 - 0.3)

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะกะฟัะพั ั ะฟะพััะตะฟะตะฝะฝัะผะธ ะธะทะผะตะฝะตะฝะธัะผะธ
    - ะัะถะฝะฐ ะฐะดะฐะฟัะธะฒะฝะพััั ะบ ะฝะตะดะฐะฒะฝะธะผ ะธะทะผะตะฝะตะฝะธัะผ
    - ะัะฐัะบะพััะพัะฝะพะต ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธะต

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะะดะฐะฟัะธััะตััั ะบ ะธะทะผะตะฝะตะฝะธัะผ ัะฟัะพัะฐ
    โ ะะพะปััะธะน ะฒะตั ะฝะตะดะฐะฒะฝะธะผ ะดะฐะฝะฝัะผ
    โ ะฅะพัะพัะพ ะดะปั ะบัะฐัะบะพััะพัะฝัั ะฟัะพะณะฝะพะทะพะฒ

    **ะะณัะฐะฝะธัะตะฝะธั:**
    โ๏ธ ะะต ััะธััะฒะฐะตั ัะตะทะพะฝะฝะพััั
    โ๏ธ ะะตะดะปะตะฝะฝะพ ัะตะฐะณะธััะตั ะฝะฐ ัะตะทะบะธะต ะธะทะผะตะฝะตะฝะธั ััะตะฝะดะฐ
    โ๏ธ ะขัะตะฑัะตั ะฝะฐัััะพะนะบะธ ะฟะฐัะฐะผะตััะฐ ฮฑ
    """,
            'holt_winters': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: HOLT-WINTERS (ะขะะะะะะ ะญะะกะะะะะะฆะะะะฌะะะ ะกะะะะะะะะะะ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ:**
    Holt-Winters - ะฟัะพะดะฒะธะฝััะฐั ะผะพะดะตะปั, ััะธััะฒะฐััะฐั ััะพะฒะตะฝั, ััะตะฝะด ะธ ัะตะทะพะฝะฝะพััั.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    - ะะพะผะฟะพะฝะตะฝั ััะพะฒะฝั: ะฑะฐะทะพะฒัะน ัะฟัะพั
    - ะะพะผะฟะพะฝะตะฝั ััะตะฝะดะฐ: ะฝะฐะฟัะฐะฒะปะตะฝะธะต ะธะทะผะตะฝะตะฝะธั (ัะพัั/ะฟะฐะดะตะฝะธะต)
    - ะะพะผะฟะพะฝะตะฝั ัะตะทะพะฝะฝะพััะธ: ะฟะพะฒัะพััััะธะตัั ะฟะฐััะตัะฝั (ะผะตัััะฝัะต, ะบะฒะฐััะฐะปัะฝัะต)
    - ะขัะธ ะฟะฐัะฐะผะตััะฐ ัะณะปะฐะถะธะฒะฐะฝะธั: ฮฑ (ััะพะฒะตะฝั), ฮฒ (ััะตะฝะด), ฮณ (ัะตะทะพะฝะฝะพััั)

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะกะฟัะพั ั ัะตะทะพะฝะฝัะผะธ ะบะพะปะตะฑะฐะฝะธัะผะธ
    - ะััั ััะตะฝะด (ัะพัั ะธะปะธ ะฟะฐะดะตะฝะธะต)
    - ะะพััะฐัะพัะฝะพ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั (ะผะธะฝะธะผัะผ 2 ัะตะทะพะฝะฐ)

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะฃัะธััะฒะฐะตั ััะตะฝะด ะธ ัะตะทะพะฝะฝะพััั
    โ ะััะพะบะฐั ัะพัะฝะพััั ะดะปั ัะตะทะพะฝะฝัั ะดะฐะฝะฝัั
    โ ะะฒัะพะผะฐัะธัะตัะบะฐั ะฐะดะฐะฟัะฐัะธั ะฟะฐัะฐะผะตััะพะฒ

    **ะะณัะฐะฝะธัะตะฝะธั:**
    โ๏ธ ะขัะตะฑัะตั ะผะธะฝะธะผัะผ 24 ะผะตัััะฐ ะดะฐะฝะฝัั ะดะปั ะผะตัััะฝะพะน ัะตะทะพะฝะฝะพััะธ
    โ๏ธ ะกะปะพะถะฝะตะต ะฒ ะฝะฐัััะพะนะบะต
    โ๏ธ ะะพะถะตั ะฟะตัะตะพะฑััะธัััั ะฝะฐ ะบะพัะพัะบะธั ััะดะฐั
    """,
            'sarima': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: SARIMA (ะกะะะะะะะฏ ะะะขะะะะะะะกะกะะะะะะฏ ะะะขะะะะะะะะะะะะฏ ะกะะะะฌะะฏะฉะะฏ ะกะะะะะฏะฏ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ะผะพะดะตะปะธ:**
    SARIMA - ะฝะฐะธะฑะพะปะตะต ะผะพัะฝะฐั ััะฐัะธััะธัะตัะบะฐั ะผะพะดะตะปั ะดะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั ะฒัะตะผะตะฝะฝัั ััะดะพะฒ.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    - AR (AutoRegressive): ะธัะฟะพะปัะทัะตั ะฟัะพัะปัะต ะทะฝะฐัะตะฝะธั
    - I (Integrated): ััะธััะฒะฐะตั ัะฐะทะฝะพััะธ ะดะปั ััะฐัะธะพะฝะฐัะฝะพััะธ
    - MA (Moving Average): ะธัะฟะพะปัะทัะตั ะฟัะพัะปัะต ะพัะธะฑะบะธ ะฟัะพะณะฝะพะทะฐ
    - S (Seasonal): ััะธััะฒะฐะตั ัะตะทะพะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั
    - ะะฐัะฐะผะตััั: (p,d,q)ร(P,D,Q,s)

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะกะปะพะถะฝัะต ะฟะฐััะตัะฝั ัะฟัะพัะฐ
    - ะกะธะปัะฝะฐั ัะตะทะพะฝะฝะพััั ะธ ััะตะฝะด
    - ะะฝะพะณะพ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั (3+ ะณะพะดะฐ)
    - ะขัะตะฑัะตััั ะผะฐะบัะธะผะฐะปัะฝะฐั ัะพัะฝะพััั

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะะฐะบัะธะผะฐะปัะฝะฐั ัะพัะฝะพััั ััะตะดะธ ััะฐัะธััะธัะตัะบะธั ะผะตัะพะดะพะฒ
    โ ะฃัะธััะฒะฐะตั ัะปะพะถะฝัะต ะทะฐะฒะธัะธะผะพััะธ
    โ ะะพะดัะพะดะธั ะดะปั ะฝะตััะฐัะธะพะฝะฐัะฝัั ััะดะพะฒ
    โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะพะดะฑะพั ะฟะฐัะฐะผะตััะพะฒ

    **ะะณัะฐะฝะธัะตะฝะธั:**
    โ๏ธ ะขัะตะฑัะตั ะผะฝะพะณะพ ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั (36+ ะผะตัััะตะฒ)
    โ๏ธ ะะพะปะณะพะต ะฒัะตะผั ัะฐััะตัะฐ
    โ๏ธ ะกะปะพะถะฝะพััั ะธะฝัะตัะฟัะตัะฐัะธะธ
    โ๏ธ ะะพะถะตั ะฟะตัะตะพะฑััะธัััั
    """,
            'auto': """
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    ๐ ะะกะะะะฌะะะะะะะะฏ ะะะะะะฌ ะะะะะะะะะะะะะะะฏ: AUTO (ะะะขะะะะขะะงะะกะะะ ะะซะะะ ะะฃะงะจะะ ะะะะะะ)
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    **ะะฟะธัะฐะฝะธะต ัะตะถะธะผะฐ:**
    ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะตััะธััะตั ะะกะ 5 ะผะพะดะตะปะตะน ะธ ะฒัะฑะธัะฐะตั ะฝะฐะธะฑะพะปะตะต ัะพัะฝัั ะดะปั ะฒะฐัะธั ะดะฐะฝะฝัั.

    **ะะฐะบ ัะฐะฑะพัะฐะตั:**
    1. ะะฐะทะดะตะปัะตั ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต ะฝะฐ ะพะฑััะฐัััั ะธ ัะตััะพะฒัั ะฒัะฑะพัะบะธ
    2. ะะฑััะฐะตั 5 ะผะพะดะตะปะตะน: Naive, Moving Average, Exponential Smoothing, Holt-Winters, SARIMA
    3. ะะฐัััะธััะฒะฐะตั ัะพัะฝะพััั ะบะฐะถะดะพะน ะผะพะดะตะปะธ (MAPE, MAE, RMSE)
    4. ะัะฑะธัะฐะตั ะผะพะดะตะปั ั ะฝะฐะธะผะตะฝััะตะน ะพัะธะฑะบะพะน (MAPE)
    5. ะัะฟะพะปัะทัะตั ััั ะผะพะดะตะปั ะดะปั ัะธะฝะฐะปัะฝะพะณะพ ะฟัะพะณะฝะพะทะฐ

    **ะัะพัะตััะธัะพะฒะฐะฝะฝัะต ะผะพะดะตะปะธ:**
    ๐น Naive - ะฑะฐะทะพะฒะฐั ะผะพะดะตะปั
    ๐น Moving Average - ัะณะปะฐะถะธะฒะฐะฝะธะต ะบะพะปะตะฑะฐะฝะธะน
    ๐น Exponential Smoothing - ะฐะดะฐะฟัะธะฒะฝะพะต ัะณะปะฐะถะธะฒะฐะฝะธะต
    ๐น Holt-Winters - ััะตะฝะด + ัะตะทะพะฝะฝะพััั
    ๐น SARIMA - ะผะฐะบัะธะผะฐะปัะฝะฐั ัะพัะฝะพััั

    **ะะพะณะดะฐ ะธัะฟะพะปัะทัะตััั:**
    - ะั ะฝะต ะทะฝะฐะตัะต, ะบะฐะบะฐั ะผะพะดะตะปั ะปัััะต
    - ะะฐะฝะฝัะต ะผะพะณัั ะธะผะตัั ัะฐะทะฝัะต ะฟะฐััะตัะฝั
    - ะัะถะฝะฐ ะผะฐะบัะธะผะฐะปัะฝะฐั ัะพัะฝะพััั ะฑะตะท ัััะฝะพะน ะฝะฐัััะพะนะบะธ

    **ะัะตะธะผััะตััะฒะฐ:**
    โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะปัััะตะน ะผะพะดะตะปะธ
    โ ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะฒััะพะบะฐั ัะพัะฝะพััั
    โ ะะต ััะตะฑัะตั ัะบัะฟะตััะฝัั ะทะฝะฐะฝะธะน
    โ ะะพะบะฐะทัะฒะฐะตั ะผะตััะธะบะธ ะบะฐัะตััะฒะฐ ะฒัะตั ะผะพะดะตะปะตะน

    **ะะตะบะพะผะตะฝะดะฐัะธั:**
    ๐ฏ ะญัะพ ะะะะะะะะะฃะะะซะ ัะตะถะธะผ ะดะปั ะฑะพะปััะธะฝััะฒะฐ ัะปััะฐะตะฒ!
    """
        }

        model_desc = model_descriptions.get(forecast_model.lower(), "")
        explanation += model_desc

    return explanation

def forecast_start_balance(historical_df, forecast_df, date_column, material_column, branch_column, end_quantity_column,
                           forecast_date_column, forecast_material_column, forecast_branch_column,
                           forecast_model='naive', seasonal_periods=12):
    """
    ะัะพะณะฝะพะทะธััะตั ะฝะฐัะฐะปัะฝัะต ะพััะฐัะบะธ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะผะพะดะตะปะตะน ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั

    Parameters:
    -----------
    forecast_model : str
        ะะพะดะตะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั: 'naive', 'moving_average', 'exponential_smoothing',
        'holt_winters', 'sarima', 'auto' (ะฟะพ ัะผะพะปัะฐะฝะธั 'naive')
    seasonal_periods : int
        ะะปะธะฝะฐ ัะตะทะพะฝะฝะพะณะพ ัะธะบะปะฐ ะดะปั ะผะพะดะตะปะตะน ั ัะตะทะพะฝะฝะพัััั (ะฟะพ ัะผะพะปัะฐะฝะธั 12 ะดะปั ะผะตัััะฝัั ะดะฐะฝะฝัั)

    Returns:
    --------
    pd.Series: ะัะพะณะฝะพะทะธัะพะฒะฐะฝะฝัะต ะฝะฐัะฐะปัะฝัะต ะพััะฐัะบะธ
    """
    forecast_start_balances = []

    for _, forecast_row in forecast_df.iterrows():
        material = forecast_row[forecast_material_column]
        branch = forecast_row[forecast_branch_column]

        # ะะพะปััะฐะตะผ ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต ะดะปั ะดะฐะฝะฝะพะณะพ ะผะฐัะตัะธะฐะปะฐ/ัะธะปะธะฐะปะฐ
        historical_series = historical_df[
            (historical_df[material_column] == material) &
            (historical_df[branch_column] == branch)
        ].sort_values(date_column)[end_quantity_column]

        if len(historical_series) == 0:
            # ะะตั ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั - ะธัะฟะพะปัะทัะตะผ 0
            forecast_start_balances.append(0)
        elif forecast_model == 'naive' or len(historical_series) < 3:
            # Naive forecast ะธะปะธ ัะปะธัะบะพะผ ะผะฐะปะพ ะดะฐะฝะฝัั
            forecast_start_balances.append(historical_series.iloc[-1])
        else:
            # ะัะฟะพะปัะทัะตะผ ะผะพะดะตะปะธ ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั
            try:
                result = fm.forecast_demand(
                    historical_series,
                    horizon=1,
                    model=forecast_model,
                    seasonal_periods=seasonal_periods
                )
                forecast_start_balances.append(result['forecast'][0])
            except Exception as e:
                # ะ ัะปััะฐะต ะพัะธะฑะบะธ fallback ะฝะฐ naive
                forecast_start_balances.append(historical_series.iloc[-1])

    return pd.Series(forecast_start_balances, index=forecast_df.index)

def auto_forecast_demand(historical_df, forecast_periods, date_column, material_column,
                         branch_column, consumption_column, forecast_model='auto',
                         seasonal_periods=12):
    """
    ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะพะณะฝะพะทะธััะตั ัะฟัะพั ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั

    Parameters:
    -----------
    historical_df : pd.DataFrame
        ะััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต
    forecast_periods : int
        ะะพะปะธัะตััะฒะพ ะฟะตัะธะพะดะพะฒ ะดะปั ะฟัะพะณะฝะพะทะฐ
    consumption_column : str
        ะะพะปะพะฝะบะฐ ั ัะฐะบัะธัะตัะบะธะผ ะฟะพััะตะฑะปะตะฝะธะตะผ/ัะฟะธัะฐะฝะธะตะผ
    forecast_model : str
        ะะพะดะตะปั ะฟัะพะณะฝะพะทะธัะพะฒะฐะฝะธั: 'auto', 'naive', 'moving_average',
        'exponential_smoothing', 'holt_winters', 'sarima'
    seasonal_periods : int
        ะะปะธะฝะฐ ัะตะทะพะฝะฝะพะณะพ ัะธะบะปะฐ (12 ะดะปั ะผะตัััะฝัั ะดะฐะฝะฝัั)

    Returns:
    --------
    pd.DataFrame: ะัะพะณะฝะพะทะฝัะต ะดะฐะฝะฝัะต ั ะบะพะปะพะฝะบะฐะผะธ [date, material, branch, forecasted_demand]
    """
    forecast_results = []

    # ะะพะปััะฐะตะผ ัะฝะธะบะฐะปัะฝัะต ะบะพะผะฑะธะฝะฐัะธะธ ะผะฐัะตัะธะฐะป/ัะธะปะธะฐะป
    groups = historical_df.groupby([material_column, branch_column])

    # ะะฟัะตะดะตะปัะตะผ ัะฐััะพัั ะดะฐะฝะฝัั (ะผะตัััะฝัะต, ะฝะตะดะตะปัะฝัะต ะธ ั.ะด.)
    historical_df[date_column] = pd.to_datetime(historical_df[date_column])
    date_freq = pd.infer_freq(historical_df[date_column].sort_values().unique())
    if date_freq is None:
        date_freq = 'MS'  # ะะพ ัะผะพะปัะฐะฝะธั ะผะตัััะฝะฐั ัะฐััะพัะฐ

    for (material, branch), group in groups:
        # ะกะพััะธััะตะผ ะฟะพ ะดะฐัะต
        group = group.sort_values(date_column)

        # ะะพะปััะฐะตะผ ะฒัะตะผะตะฝะฝะพะน ััะด ะฟะพััะตะฑะปะตะฝะธั
        consumption_series = group[consumption_column]

        if len(consumption_series) < 3:
            # ะกะปะธัะบะพะผ ะผะฐะปะพ ะดะฐะฝะฝัั - ะธัะฟะพะปัะทัะตะผ naive forecast
            forecasted_values = [consumption_series.iloc[-1]] * forecast_periods
        else:
            # ะัะฟะพะปัะทัะตะผ ะฒัะฑัะฐะฝะฝัั ะผะพะดะตะปั
            try:
                result = fm.forecast_demand(
                    consumption_series,
                    horizon=forecast_periods,
                    model=forecast_model,
                    seasonal_periods=seasonal_periods
                )
                forecasted_values = result['forecast']
            except Exception as e:
                # Fallback ะฝะฐ naive
                forecasted_values = [consumption_series.iloc[-1]] * forecast_periods

        # ะะตะฝะตัะธััะตะผ ะฑัะดััะธะต ะดะฐัั
        last_date = group[date_column].max()
        future_dates = pd.date_range(
            start=last_date + pd.DateOffset(months=1 if date_freq == 'MS' else 7),
            periods=forecast_periods,
            freq=date_freq
        )

        # ะกะพะทะดะฐะตะผ ะทะฐะฟะธัะธ ะฟัะพะณะฝะพะทะฐ
        for date, demand in zip(future_dates, forecasted_values):
            forecast_results.append({
                date_column: date,
                material_column: material,
                branch_column: branch,
                'ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะฐั ะฟะพััะตะฑะฝะพััั': max(0, demand)  # ะะต ะดะพะฟััะบะฐะตะผ ะพััะธัะฐัะตะปัะฝัะต ะทะฝะฐัะตะฝะธั
            })

    return pd.DataFrame(forecast_results)


def calculate_forward_rolling_sum(series, window=3):
    """
    ะััะธัะปัะตั rolling sum ะะะะะะ (ัะตะบััะธะน + ัะปะตะดัััะธะต ะฟะตัะธะพะดั)
    ะฒะผะตััะพ ััะฐะฝะดะฐััะฝะพะณะพ rolling (ัะตะบััะธะน + ะฟัะตะดัะดััะธะต ะฟะตัะธะพะดั)
    """
    result = []
    for i in range(len(series)):
        # ะกัะผะผะธััะตะผ ะพั ัะตะบััะตะณะพ ะดะพ ัะตะบััะตะณะพ+window (ะฝะต ะฒะบะปััะฐั)
        window_sum = series.iloc[i:min(i+window, len(series))].sum()
        result.append(window_sum)
    return pd.Series(result, index=series.index)


def calculate_purchase_recommendations(df, end_quantity_column, forecast_quantity_column, safety_stock_percent):
    safety_stock = df[forecast_quantity_column] * safety_stock_percent

    # ะะกะะะะะะะะะ ะะจะะะะ #2: ะัะฟะพะปัะทัะตะผ forward rolling sum (ัะตะบััะธะน + 2 ัะปะตะดัััะธั)
    # ะฒะผะตััะพ backward rolling sum (ัะตะบััะธะน + 2 ะฟัะตะดัะดััะธั)
    future_demand = calculate_forward_rolling_sum(df[forecast_quantity_column], window=3)

    recommendations = np.maximum(0, future_demand + safety_stock - df[end_quantity_column])

    return pd.DataFrame({
        'ะะตะบะพะผะตะฝะดะฐัะธั ะฟะพ ะทะฐะบัะฟะบะต': recommendations,
        'ะัะดััะธะน ัะฟัะพั': future_demand,
        'ะกััะฐัะพะฒะพะน ะทะฐะฟะฐั': safety_stock
    })

def analyze_coverage(df, start_quantity_column, forecast_quantity_column):
    total_inventory = df[start_quantity_column].sum()
    total_demand = df[forecast_quantity_column].sum()
    coverage_ratio = total_inventory / total_demand
    
    if coverage_ratio >= 1:
        return f"ะขะตะบััะธะต ะทะฐะฟะฐัั ะฟะพะบััะฒะฐัั {coverage_ratio:.2f} ะพั ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะน ะฟะพััะตะฑะฝะพััะธ."
    else:
        shortage = total_demand - total_inventory
        return f"ะขะตะบััะธั ะทะฐะฟะฐัะพะฒ ะฝะตะดะพััะฐัะพัะฝะพ. ะะตัะฒะฐัะบะฐ ัะพััะฐะฒะปัะตั {shortage:.0f} ะตะดะธะฝะธั."

def plot_top_materials_by_cost(df, material_column, cost_column):
    top_materials = df.groupby(material_column)[cost_column].sum().nlargest(10).reset_index()
    fig = px.bar(top_materials, x=material_column, y=cost_column, title='ะขะพะฟ 10 ะผะฐัะตัะธะฐะปะพะฒ ะฟะพ ััะพะธะผะพััะธ')
    return fig

def analyze_materials(df, material_column, date_column, start_quantity_column, end_quantity_column):
    df['month'] = pd.to_datetime(df[date_column]).dt.month
    df['usage'] = df[start_quantity_column] - df[end_quantity_column]
    
    analysis = df.groupby(material_column).agg({
        'usage': ['mean', 'std'],
        start_quantity_column: 'mean',
        end_quantity_column: 'mean'
    }).reset_index()
    
    analysis.columns = [material_column, 'ะกัะตะดะฝะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต', 'ะกัะฐะฝะดะฐััะฝะพะต ะพัะบะปะพะฝะตะฝะธะต ะธัะฟะพะปัะทะพะฒะฐะฝะธั', 
                        'ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะฝะฐัะฐะปะพ', 'ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะบะพะฝะตั']
    
    analysis['ะะพัััะธัะธะตะฝั ะฒะฐัะธะฐัะธะธ'] = analysis['ะกัะฐะฝะดะฐััะฝะพะต ะพัะบะปะพะฝะตะฝะธะต ะธัะฟะพะปัะทะพะฒะฐะฝะธั'] / analysis['ะกัะตะดะฝะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต']
    analysis['ะกะตะทะพะฝะฝะพััั'] = analysis['ะะพัััะธัะธะตะฝั ะฒะฐัะธะฐัะธะธ'] > 0.5
    
    def get_seasonality_info(material):
        material_data = df[df[material_column] == material]
        monthly_usage = material_data.groupby('month')['usage'].mean()
        high_season = monthly_usage.nlargest(3).index.tolist()
        low_season = monthly_usage.nsmallest(3).index.tolist()
        return f"ะััะพะบะธะน ัะตะทะพะฝ: {', '.join(map(str, high_season))}, ะะธะทะบะธะน ัะตะทะพะฝ: {', '.join(map(str, low_season))}"
    
    analysis['ะะฝัะพัะผะฐัะธั ะพ ัะตะทะพะฝะฝะพััะธ'] = analysis.apply(lambda row: get_seasonality_info(row[material_column]) if row['ะกะตะทะพะฝะฝะพััั'] else "ะะต ัะตะทะพะฝะฝัะน", axis=1)
    analysis['ะะฑะพัะฐัะธะฒะฐะตะผะพััั'] = analysis['ะกัะตะดะฝะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต'] / ((analysis['ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะฝะฐัะฐะปะพ'] + analysis['ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะบะพะฝะตั']) / 2)
    
    analysis['ะัะพะฑะปะตะผั ั ะทะฐะฟะฐัะพะผ'] = analysis.apply(lambda row: 
        "ะะทะปะธัะตะบ" if row['ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะบะพะฝะตั'] > 2 * row['ะกัะตะดะฝะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต'] 
        else ("ะะตัะธัะธั" if row['ะกัะตะดะฝะธะน ะพััะฐัะพะบ ะฝะฐ ะบะพะฝะตั'] < 0.5 * row['ะกัะตะดะฝะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต'] 
              else "ะะพัะผะฐะปัะฝัะน ััะพะฒะตะฝั"), axis=1)
    
    return analysis